import{r as d,df as E,j as r,B as k,dg as _,T as C,l as T,dh as P,aF as R,a as O,v as A,w as F,n as B,di as D,dj as z}from"./index-DthS9im-.js";import{S as G,P as W,F as N}from"./PageService-C9ZyUdN0.js";import"./Card-D6qwUXAG.js";import"./CardHeader-DdK2ANCW.js";import"./CardContent-mIErzORI.js";import"./Clear-AvwY9pTL.js";import"./SearchIcon-Ch7TZ4TL.js";import"./groupByKey-nGMiMvM1.js";import"./Autocomplete-BOeus3py.js";import"./usePreviousProps-sMvt-2hG.js";const U=({data:u,socket:a,onClick:M,controller:x,region:l})=>{const[i,g]=d.useState(u),S=()=>{M({...i,ctrl_id:x.ctrl_id,nodo:x.nodo,region:l})},o=i.actual?E(i.actual,i.umbral_alarma):"normal";return d.useEffect(()=>{a.current&&a.current.on("temperature",(c,f,w)=>{switch(w){case"update":x.ctrl_id===c&&i.st_id===f.st_id&&g(f);break}})},[a]),r.jsxs(k,{sx:{display:"flex",flexDirection:"column",rowGap:1,backgroundColor:"background.paper",borderRadius:"8px",borderWidth:1,borderStyle:"solid",borderColor:"divider",padding:1.5,":hover":{backgroundColor:_[o].container.background},cursor:"pointer"},onClick:S,children:[r.jsx(C,{variant:"subtitle1",color:"textPrimary",sx:{overflow:"hidden",textWrap:"nowrap",textOverflow:"ellipsis"},children:i.ubicacion}),r.jsxs(T,{direction:"row",spacing:1,alignItems:"center",children:[r.jsx(k,{sx:{width:32,height:32,borderRadius:"8px",display:"grid",placeItems:"center",backgroundColor:_[o].icon.background,color:_[o].icon.color},children:r.jsx(P,{state:o})}),r.jsx(C,{variant:"body1",color:"textPrimary",children:i.actual??"*"})]})]})},V=({data:u,socket:a,region:M,onClick:x})=>{const[l,i]=d.useState(u.controlador),[g,S]=d.useState(u.temperature);return d.useEffect(()=>{a.current&&(a.current.on("temperature",(o,c,f)=>{switch(f){case"add":l.ctrl_id===o&&S(w=>{const j=new Map(w);return j.set(c.st_id,c),j});break;case"delete":l.ctrl_id===o&&S(w=>{const j=new Map(w);return j.delete(c.st_id),j});break}}),a.current.on("controller",(o,c,f)=>{switch(f){case"update":l.ctrl_id===o&&i(c);break}}))},[a]),r.jsx(G,{title:l.nodo,children:r.jsx(T,{spacing:2,children:g.size>0&&r.jsx(R,{container:!0,rowSpacing:2,columnSpacing:2,width:"100%",marginTop:1,children:Array.from(g).map(([o,c])=>r.jsx(R,{size:{xs:6},children:r.jsx(U,{data:c,socket:a,controller:l,region:M,onClick:x})},o))})})})},$=()=>{const{rgn_id:u,ctrl_id:a,state:M}=O(e=>e.temperatureServiceStore),[x,l]=d.useState(new Map),[i,g]=d.useState(new Map),[S,o]=d.useState(!1),[c,f]=d.useState(null),w=e=>{f(e),o(!0)},j=d.useMemo(()=>{const e=new Map;for(const[,s]of i){const t=s.controlador.rgn_id,n=s.controlador.ctrl_id;if(u!==void 0&&String(t)!==String(u)||a!==void 0&&String(n)!==String(a))continue;const h=e.get(t);h===void 0?e.set(t,[s]):h.push(s)}return Array.from(e.values()).reduce((s,t)=>{const n=s,h=t;if(h[0]){const b=x.get(h[0].controlador.rgn_id);b!==void 0&&n.push({rgn_id:b.rgn_id,region:b.region,nodos:e.get(b.rgn_id)??[]})}return n},[])},[i,u,a,M]),p=d.useRef(null);return d.useEffect(()=>(p.current||(p.current=A(`${F}/temperature`,{withCredentials:!0})),p.current.on("initial_data",(e,m)=>{const s=new Map;m.forEach(n=>{s.set(n.rgn_id,n)}),l(s);const t=new Map;Object.values(e).forEach(n=>{const{controlador:h,sensor_temperature:b}=n,y=b.map(v=>[v.st_id,v]),I={controlador:h,temperature:new Map(y)};t.set(h.ctrl_id,I)}),g(t)}),p.current.on("region",(e,m)=>{l(s=>{const t=new Map(s);return t.set(e,m),t})}),p.current.on("controller",(e,m,s)=>{switch(s){case"add":g(t=>{if(!t.has(e)){const n=new Map([...t]);return n.set(e,{controlador:m,temperature:new Map}),n}return t});break;case"delete":g(t=>{if(t.has(e)){const n=new Map([...t]);return n.delete(e),n}return t});break}}),()=>{p.current&&(p.current.disconnect(),p.current=null)}),[]),r.jsxs(T,{spacing:2,overflow:"hidden",children:[j.map(e=>r.jsxs(T,{overflow:"hidden",children:[r.jsx(C,{variant:"h5",children:e.region}),r.jsx(B,{sx:{width:"100%",height:"100%"},children:r.jsx(T,{spacing:2,direction:"row",py:2,children:e.nodos.map(m=>r.jsx(V,{data:m,socket:p,region:e.region,onClick:w},m.controlador.ctrl_id))})})]},e.rgn_id)),c&&S&&r.jsx(D,{open:S,setOpen:o,data:c})]})},re=()=>r.jsx(W,{title:"Temperatura",filter:r.jsx(N,{storeSelector:u=>u.temperatureServiceStore,updateStoreAction:z}),children:r.jsx($,{})});export{re as default};
